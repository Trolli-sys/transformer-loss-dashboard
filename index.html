<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดวิเคราะห์ค่า Loss หม้อแปลง - ระบบจัดการมืออาชีพ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --success-500: #10b981;
            --warning-500: #f59e0b;
            --error-500: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        .metric-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            background: var(--gray-100);
            color: var(--gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--gray-700);
            border: 1px solid rgba(229, 231, 235, 0.8);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary-500);
            color: var(--primary-600);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .input-field, .textarea-field {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(229, 231, 235, 0.5);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .input-field:focus, .textarea-field:focus {
            outline: none;
            border-color: var(--primary-500);
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .textarea-field {
            min-height: 120px;
            resize: vertical;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            gap: 0.5rem;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-500);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-500);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-500);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .data-table {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(229, 231, 235, 0.5);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: var(--gray-700);
            text-align: left;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }

        .data-table td {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(229, 231, 235, 0.3);
            color: var(--gray-700);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-top: 0.5rem;
        }

        .metric-label {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 40;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-content.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        .ai-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-600);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(229, 231, 235, 0.3);
        }
        
        .admin-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--gray-500);
        }
        .admin-tab:hover {
            color: var(--primary-500);
        }
        .admin-tab.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
            font-weight: 700;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 2rem;
            }

            .glass-card {
                margin: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Login Modal -->
    <div id="login-modal-overlay" class="modal-overlay hidden">
        <div id="login-modal" class="modal-content w-full max-w-md mx-4">
            <form id="login-form" class="glass-card p-8 relative">
                <button type="button" id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <div class="text-center mb-6">
                    <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">เข้าสู่ระบบ Admin</h2>
                    <p class="text-gray-500 mt-2">เพื่อเข้าถึงฟังก์ชันการจัดการขั้นสูง</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้</label>
                        <input type="text" id="username" class="input-field" placeholder="กรุณาใส่ชื่อผู้ใช้" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
                        <input type="password" id="password" class="input-field" placeholder="กรุณาใส่รหัสผ่าน" required>
                    </div>
                    <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                    <button type="submit" class="w-full btn-primary">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                        เข้าสู่ระบบ
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal-overlay" class="modal-overlay hidden">
        <div id="confirm-modal" class="modal-content w-full max-w-md mx-4">
            <div class="glass-card p-8 relative text-center">
                <h3 id="confirm-modal-title" class="text-xl font-bold text-gray-900 mb-4">ยืนยันการกระทำ</h3>
                <p id="confirm-modal-text" class="text-gray-600 mb-6">คุณแน่ใจหรือไม่ว่าต้องการดำเนินการต่อ?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-modal-cancel-btn" class="btn-secondary">ยกเลิก</button>
                    <button id="confirm-modal-confirm-btn" class="btn-primary bg-red-600 hover:bg-red-700">ยืนยัน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Edit Report Modal -->
    <div id="edit-report-modal-overlay" class="modal-overlay hidden">
        <div id="edit-report-modal" class="modal-content w-full max-w-2xl mx-4">
            <form id="edit-report-form" class="glass-card p-8 relative">
                 <button type="button" id="close-edit-report-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h2 class="text-2xl font-bold text-gray-900 mb-6">บันทึกรายงานการแก้ไขหม้อแปลง</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="report-name" class="block text-sm font-medium text-gray-700 mb-2">ชื่อ-สกุล ผู้รายงาน</label>
                            <input type="text" id="report-name" class="input-field" placeholder="เช่น นายสมชาย ใจดี" required>
                        </div>
                        <div>
                            <label for="report-position" class="block text-sm font-medium text-gray-700 mb-2">ตำแหน่ง</label>
                            <input type="text" id="report-position" class="input-field" placeholder="เช่น วิศวกรไฟฟ้า" required>
                        </div>
                    </div>
                    <div>
                        <label for="report-affiliation" class="block text-sm font-medium text-gray-700 mb-2">สังกัด</label>
                        <input type="text" id="report-affiliation" class="input-field" placeholder="เช่น การไฟฟ้าส่วนภูมิภาคยะลา" required>
                    </div>
                    <div>
                        <label for="report-details" class="block text-sm font-medium text-gray-700 mb-2">รายละเอียดการแก้ไข</label>
                        <textarea id="report-details" class="textarea-field" placeholder="อธิบายการดำเนินการแก้ไขปัญหาตามบทวิเคราะห์ของ AI..." required></textarea>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="btn-primary">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            ส่งรายงาน
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin View Report Details Modal -->
    <div id="report-details-modal-overlay" class="modal-overlay hidden">
        <div id="report-details-modal" class="modal-content w-full max-w-3xl mx-4">
            <div class="glass-card p-8 relative max-h-[90vh] overflow-y-auto">
                <button type="button" id="close-report-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h2 class="text-2xl font-bold text-gray-900 mb-6">รายละเอียดรายงานการแก้ไข</h2>
                <div class="space-y-6">
                    <!-- User Report Section -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-800 mb-3">ข้อมูลจากผู้ใช้</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div><strong class="text-gray-500">ผู้รายงาน:</strong> <span id="details-reporter-name"></span></div>
                            <div><strong class="text-gray-500">ตำแหน่ง:</strong> <span id="details-reporter-position"></span></div>
                            <div><strong class="text-gray-500">สังกัด:</strong> <span id="details-reporter-affiliation"></span></div>
                            <div><strong class="text-gray-500">หม้อแปลง:</strong> <span id="details-transformer-id"></span></div>
                            <div><strong class="text-gray-500">การไฟฟ้า:</strong> <span id="details-authority"></span></div>
                            <div><strong class="text-gray-500">วันที่รายงาน:</strong> <span id="details-created-at"></span></div>
                        </div>
                        <div class="mt-4">
                            <strong class="text-gray-500 text-sm">รายละเอียดการแก้ไข:</strong>
                            <p class="mt-1 text-gray-700 bg-white p-3 rounded-md" id="details-report-details"></p>
                        </div>
                    </div>

                    <!-- Admin Suggestion Section -->
                    <div class="p-4 border rounded-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-lg text-gray-800">ข้อเสนอแนะจาก Admin</h3>
                            <button id="generate-suggestion-ai-btn" class="btn-secondary text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                                <span>สร้างด้วย AI</span>
                            </button>
                        </div>
                        <div>
                            <label for="admin-suggestions" class="block text-sm font-medium text-gray-700 mb-2">เพิ่ม/แก้ไขข้อเสนอแนะ</label>
                            <textarea id="admin-suggestions" class="textarea-field" placeholder="เพิ่มความคิดเห็นหรือข้อเสนอแนะเพิ่มเติมที่นี่..."></textarea>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                             <button id="delete-report-btn" class="btn-secondary bg-red-50 text-red-600 hover:bg-red-100 border-red-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                <span>ลบรายงานนี้</span>
                            </button>
                            <button id="save-admin-suggestion-btn" class="btn-primary">บันทึกข้อเสนอแนะ</button>
                        </div>
                    </div>

                    <!-- AI Analysis of Report -->
                    <div class="p-4 border rounded-lg">
                         <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-lg text-gray-800">บทวิเคราะห์รายงานโดย AI</h3>
                            <button id="analyze-report-btn" class="btn-secondary">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                                <span>วิเคราะห์</span>
                            </button>
                        </div>
                        <div id="report-ai-loader" class="flex flex-col items-center justify-center h-24 hidden">
                            <div class="ai-spinner mb-2"></div>
                            <p class="text-gray-500 text-sm">AI กำลังวิเคราะห์รายงาน...</p>
                        </div>
                        <div id="report-ai-analysis-content" class="prose max-w-none text-gray-600"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Main Application -->
    <div id="app-container" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-gray-200/50 sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">ระบบวิเคราะห์ค่า Loss</h1>
                            <p class="text-sm text-gray-500">Transformer Loss Analysis System</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <div class="hidden sm:block">
                            <span class="text-sm text-gray-500">สวัสดี, </span>
                            <span id="user-role-display" class="text-sm font-semibold text-gray-900"></span>
                        </div>
                        <button id="admin-login-btn" class="btn-secondary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            Admin
                        </button>
                        <button id="logout-btn" class="btn-secondary hidden">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                            </svg>
                            ออกจากระบบ
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
            <!-- Admin Panel (with Tabs) -->
            <section id="admin-panel" class="admin-only hidden fade-in">
                <div class="glass-card p-8">
                    <!-- Admin Tabs Navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-4" aria-label="Tabs">
                            <button id="admin-config-tab" class="admin-tab active">
                                ตั้งค่าและคำนวณ
                            </button>
                            <button id="admin-reports-tab" class="admin-tab">
                                รายงานการแก้ไขจากผู้ใช้
                            </button>
                        </nav>
                    </div>

                    <!-- Admin Configuration Section -->
                    <div id="admin-config-section">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900">ตั้งค่าระบบและเชื่อมต่อข้อมูล</h2>
                        </div>
                        <!-- Data Source Configuration -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="space-y-6">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    ข้อมูลหม้อแปลง
                                </h3>
                                <input type="url" id="transformer-url" class="input-field" placeholder="วาง Google Sheets URL ของข้อมูลหม้อแปลง">
                                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                    <div class="flex">
                                        <svg class="w-5 h-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="ml-3">
                                            <p class="text-sm text-blue-700">
                                                <strong>วิธีการ:</strong> เปิด Google Sheets → คลิกแท็บ "DATA_Process" → คัดลอก URL จากแถบที่อยู่<br>
                                                <strong>โครงสร้างข้อมูล:</strong> ต้องมีคอลัมน์ วันที่, KWH_TOT, PF_TOT, P_TOT
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    ข้อมูลมิเตอร์
                                </h3>
                                <input type="url" id="meter-url" class="input-field" placeholder="วาง Google Sheets URL ของข้อมูลมิเตอร์">
                                <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
                                    <div class="flex">
                                        <svg class="w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="ml-3">
                                            <p class="text-sm text-green-700">
                                                <strong>วิธีการ:</strong> เปิด Google Sheets → เลือกแท็บที่มีข้อมูลมิเตอร์ → คัดลอก URL จากแถบที่อยู่<br>
                                                <strong>โครงสร้างข้อมูล:</strong> ต้องมีคอลัมน์ PEA Meter, หม้อแปลง, KWH_JAN, KWH_FEB, ..., KWH_DEC
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Parameters -->
                        <div class="border-t border-gray-200 pt-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                                <svg class="w-5 h-5 text-orange-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                </svg>
                                พารามิเตอร์การวิเคราะห์
                            </h3>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                <div>
                                    <label for="authority-input" class="block text-sm font-medium text-gray-700 mb-2">การไฟฟ้าที่รับผิดชอบ</label>
                                    <input type="text" id="authority-input" class="input-field" placeholder="เช่น ยะลา, สงขลา">
                                </div>
                                <div>
                                    <label for="start-date-input" class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label>
                                    <input type="date" id="start-date-input" class="input-field">
                                </div>
                                <div>
                                    <label for="end-date-input" class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label>
                                    <input type="date" id="end-date-input" class="input-field">
                                </div>
                                <div>
                                    <label for="month-input" class="block text-sm font-medium text-gray-700 mb-2">เดือนข้อมูลมิเตอร์</label>
                                    <input type="month" id="month-input" class="input-field">
                                </div>
                            </div>

                            <!-- Auto-detected Mapping Display -->
                            <div class="bg-blue-50 rounded-xl p-6 mb-8">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <svg class="w-6 h-6 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <h4 class="text-lg font-semibold text-blue-800">การจับคู่อัตโนมัติ</h4>
                                    </div>
                                    <button id="detect-mappings-btn" class="btn-primary text-sm" disabled>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span id="detect-btn-text">ใส่ลิงก์มิเตอร์ก่อน</span>
                                    </button>
                                </div>
                                <p class="text-blue-700 mb-4">
                                    <strong>📊 การคำนวณ Loss:</strong><br>
                                    • <strong>หม้อแปลง:</strong> KWH_TOT(วันสิ้นสุด) - KWH_TOT(วันเริ่ม) = พลังงานจ่ายออก<br>
                                    • <strong>มิเตอร์:</strong> ผลรวม KWH_(เดือนที่เลือก) ของมิเตอร์ทั้งหมด = พลังงานรับเข้า<br>
                                    • <strong>Loss:</strong> พลังงานจ่ายออก - พลังงานรับเข้า = การสูญเสีย
                                </p>

                                <!-- URL Status Indicator -->
                                <div class="mb-4 p-3 bg-white rounded-lg border border-blue-200">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-blue-800">สถานะลิงก์ไฟล์:</span>
                                        <div class="flex space-x-4 text-xs">
                                            <span id="transformer-url-status" class="px-2 py-1 rounded-full bg-gray-100 text-gray-600">
                                                🔌 หม้อแปลง: ยังไม่ได้ใส่
                                            </span>
                                            <span id="meter-url-status" class="px-2 py-1 rounded-full bg-gray-100 text-gray-600">
                                                📊 มิเตอร์: ยังไม่ได้ใส่
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div id="detected-mappings" class="space-y-3">
                                    <div class="text-blue-600 text-sm flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        ใส่ลิงก์ Google Sheets ของไฟล์มิเตอร์ข้างบน แล้วกดปุ่ม "ตรวจสอบการจับคู่"
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end space-x-4">
                                 <button id="delete-btn" class="btn-secondary bg-red-50 text-red-600 hover:bg-red-100 border-red-200 hidden">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    <span>ลบข้อมูลที่แสดง</span>
                                </button>
                                <button id="calculate-btn" class="btn-primary" disabled>
                                    <svg id="loading-spinner" class="spinner hidden" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>คำนวณและบันทึกข้อมูล</span>
                                </button>
                            </div>

                            <div id="error-message" class="mt-4 hidden">
                                <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-r-lg">
                                    <div class="flex">
                                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="ml-3">
                                            <p class="text-sm text-red-700" id="error-text"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Reports Section -->
                    <div id="admin-reports-section" class="hidden">
                         <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900">รายงานการแก้ไขจากผู้ใช้</h2>
                        </div>
                        <div id="reports-list-container" class="overflow-x-auto">
                            <!-- Reports will be dynamically loaded here -->
                            <p id="no-reports-message" class="text-center text-gray-500 py-8">ยังไม่มีรายงานการแก้ไข</p>
                            <table class="data-table w-full hidden">
                                <thead>
                                    <tr>
                                        <th>วันที่รายงาน</th>
                                        <th>ผู้รายงาน</th>
                                        <th>สังกัด</th>
                                        <th>หม้อแปลง</th>
                                        <th>สถานะ</th>
                                        <th>การดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody id="reports-table-body">
                                    <!-- report rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section id="results-section" class="hidden fade-in">
                <!-- Overall Summary Section -->
                <section id="overall-summary-section" class="hidden fade-in">
                    <div class="glass-card p-6 mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center mb-6">
                            <svg class="w-6 h-6 text-indigo-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 00-4-4H3V7h2a4 4 0 004-4v-2m0 16l6-6m-6 6l6 6m-6-6H9m6 0h2a4 4 0 004-4V7h2a4 4 0 00-4-4h-2m-6 0l-6 6m6-6l-6-6"></path></svg>
                            ภาพรวมข้อมูลทั้งหมด (ล่าสุด)
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <!-- Card 1: Total Transformers -->
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200 text-center">
                                <div class="metric-label text-blue-800">หม้อแปลงที่วิเคราะห์</div>
                                <div class="text-3xl font-bold text-blue-600 mt-1" id="summary-total-transformers">0</div>
                            </div>
                            <!-- Card 2: Total Meters -->
                            <div class="p-4 bg-green-50 rounded-xl border border-green-200 text-center">
                                <div class="metric-label text-green-800">มิเตอร์ที่เชื่อมต่อ</div>
                                <div class="text-3xl font-bold text-green-600 mt-1" id="summary-total-meters">0</div>
                            </div>
                            <!-- Card 3: Total Energy Out -->
                            <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200 text-center">
                                <div class="metric-label text-indigo-800">รวมพลังงานจ่ายออก</div>
                                <div class="text-3xl font-bold text-indigo-600 mt-1" id="summary-energy-out">0</div>
                                <div class="text-xs text-gray-500">kWh</div>
                            </div>
                            <!-- Card 4: Total Energy In -->
                            <div class="p-4 bg-purple-50 rounded-xl border border-purple-200 text-center">
                                <div class="metric-label text-purple-800">รวมพลังงานรับเข้า</div>
                                <div class="text-3xl font-bold text-purple-600 mt-1" id="summary-energy-in">0</div>
                                <div class="text-xs text-gray-500">kWh</div>
                            </div>
                            <!-- Card 5: Total Loss -->
                            <div class="p-4 bg-red-50 rounded-xl border border-red-200 text-center">
                                <div class="metric-label text-red-800">รวมค่า Loss</div>
                                <div class="text-3xl font-bold text-red-600 mt-1" id="summary-total-loss">0</div>
                                <div class="text-xs text-gray-500">kWh</div>
                            </div>
                            <!-- Card 6: Overall Loss % -->
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-200 text-center">
                                <div class="metric-label text-orange-800">ภาพรวม Loss</div>
                                <div class="text-3xl font-bold text-orange-600 mt-1" id="summary-loss-percent">0%</div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Highest Loss Chart Section -->
                <section id="highest-loss-section" class="hidden fade-in">
                    <div class="glass-card p-6 mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center mb-6">
                            <svg class="w-6 h-6 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                            10 อันดับหม้อแปลงที่ค่า Loss สูงสุด (ล่าสุด)
                        </h2>
                        <div class="chart-container">
                            <div id="highest-loss-chart"></div>
                        </div>
                    </div>
                </section>

                <!-- Filter Controls -->
                <div class="glass-card p-6 mb-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                            <svg class="w-6 h-6 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            ผลการวิเคราะห์ค่า Loss
                        </h2>

                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <select id="view-authority-select" class="input-field">
                                <option value="">-- เลือกการไฟฟ้า --</option>
                            </select>
                            <select id="view-transformer-select" class="input-field">
                                <option value="">-- เลือกหม้อแปลง --</option>
                            </select>
                            <select id="view-month-select" class="input-field">
                                <option value="">-- เลือกเดือน --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Admin Feedback Section for User -->
                <div id="user-view-report-feedback-section" class="hidden glass-card p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <svg class="w-6 h-6 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        ข้อเสนอแนะจากผู้ดูแลระบบ
                    </h3>
                    <div id="user-view-feedback-content" class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg text-green-800">
                        <!-- Feedback content will be loaded here -->
                    </div>
                </div>


                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card">
                        <div class="metric-label">พลังงานจ่ายออก</div>
                        <div class="metric-value text-blue-600" id="kpi-transformer-energy">0</div>
                        <div class="text-sm text-gray-500 mt-1">kWh</div>
                        <div class="absolute top-4 right-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">พลังงานรับเข้า</div>
                        <div class="metric-value text-green-600" id="kpi-meter-energy">0</div>
                        <div class="text-sm text-gray-500 mt-1">kWh</div>
                        <div class="absolute top-4 right-4">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">ค่า Loss</div>
                        <div class="metric-value text-red-600" id="kpi-loss">0</div>
                        <div class="text-sm text-gray-500 mt-1">kWh</div>
                        <div class="absolute top-4 right-4">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">เปอร์เซ็นต์ Loss</div>
                        <div class="metric-value text-orange-600" id="kpi-loss-percent">0%</div>
                        <div class="text-sm text-gray-500 mt-1">ของพลังงานรวม</div>
                        <div class="absolute top-4 right-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Trend Chart -->
                    <div class="lg:col-span-2">
                        <div class="chart-container">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800">แนวโน้มการใช้พลังงานรายเดือน</h3>
                                <div class="flex space-x-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-1"></span>
                                        หม้อแปลง
                                    </span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                                        มิเตอร์
                                    </span>
                                </div>
                            </div>
                            <div id="consumption-trend-chart"></div>
                        </div>
                    </div>

                    <!-- Key Metrics -->
                    <div class="chart-container">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">ตัวชี้วัดสำคัญ</h3>
                        <div class="space-y-6">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="metric-label">Power Factor เฉลี่ย</div>
                                    <div class="text-2xl font-bold" id="metric-pf">0.00</div>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="metric-label">ความต้องการสูงสุด</div>
                                    <div class="text-2xl font-bold text-gray-800" id="metric-peak-power">0 kW</div>
                                </div>
                                <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                    </svg>
                                </div>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="metric-label">วันที่เกิด Peak</div>
                                    <div class="text-lg text-gray-600" id="metric-peak-date">-</div>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Meter Consumption Chart -->
                    <div class="chart-container">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">10 อันดับมิเตอร์ที่ใช้พลังงานสูงสุด</h3>
                        <div id="meter-consumption-chart"></div>
                    </div>

                    <!-- AI Analysis -->
                    <div class="chart-container">
                        <div class="flex justify-between items-start">
                             <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 text-purple-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                บทวิเคราะห์ AI
                            </h3>
                        </div>

                        <div id="ai-analysis-loader" class="flex flex-col items-center justify-center h-64">
                            <div class="ai-spinner mb-4"></div>
                            <p class="text-gray-500 text-center">กำลังวิเคราะห์ข้อมูลด้วย AI...</p>
                        </div>

                        <div id="ai-analysis-content" class="prose max-w-none text-gray-600 hidden"></div>
                        
                        <div id="action-buttons-container" class="mt-4 space-y-2 hidden">
                            <button id="generate-action-plan-btn" class="btn-primary w-full">✨ สร้างแผนปฏิบัติการ</button>
                            <button id="show-edit-report-modal-btn" class="btn-secondary w-full">📝 บันทึกการแก้ไขตามบทวิเคราะห์</button>
                        </div>

                        <div id="ai-analysis-error" class="hidden">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex">
                                    <svg class="w-5 h-5 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="ml-3">
                                        <p class="text-sm text-red-700" id="ai-error-text"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Plan Section -->
                        <div id="action-plan-section" class="mt-6 hidden">
                            <h4 class="text-md font-bold text-gray-800 mb-4 flex items-center">
                                <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                                แผนปฏิบัติการ (Action Plan)
                            </h4>
                            <div id="action-plan-loader" class="flex flex-col items-center justify-center h-40 hidden">
                                <div class="ai-spinner mb-4"></div>
                                <p class="text-gray-500 text-center">กำลังสร้างแผนปฏิบัติการ...</p>
                            </div>
                            <div id="action-plan-content" class="prose max-w-none text-gray-600 hidden p-4 bg-gray-50 rounded-lg border"></div>
                            <div id="action-plan-error" class="hidden">
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <p class="text-sm text-red-700" id="action-plan-error-text"></p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Detailed Table (Admin Only) -->
                <div id="detailed-table-card" class="admin-only hidden">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <svg class="w-6 h-6 text-gray-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                            </svg>
                            ตารางข้อมูลโดยละเอียด
                        </h3>

                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>ID หม้อแปลง</th>
                                        <th>พลังงานจ่ายออก (kWh)</th>
                                        <th>พลังงานรับเข้ารวม (kWh)</th>
                                        <th>ค่า Loss (kWh)</th>
                                        <th>ค่า Loss (%)</th>
                                        <th>สถานะ</th>
                                        <th>มิเตอร์ที่เชื่อมต่อ</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table">
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- User Waiting Message -->
            <div id="user-waiting-message" class="glass-card p-12 text-center">
                <div class="max-w-md mx-auto">
                    <div class="w-24 h-24 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">รอการอัปเดตข้อมูล</h3>
                    <p class="text-gray-600 mb-6">ยังไม่มีข้อมูลการวิเคราะห์ กรุณารอให้ผู้ดูแลระบบทำการประมวลผลข้อมูล</p>
                    <div class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        กำลังรอข้อมูล
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        const { createClient } = window.supabase;

        // --- GLOBAL STATE ---
        let currentUser = { role: 'user' };
        let charts = { trend: null, meter: null, highestLoss: null }; // Added highestLoss chart
        let analysisDone = false;
        let transformerMeterMappings = [];
        let currentAnalysisText = ''; // To store AI analysis for action plan
        let currentDataSummary = ''; // To store data summary for action plan
        let supabase;
        let allAnalysisData = {}; // Global cache for Supabase data
        let currentReportId = null; // To track which report is being viewed/edited by admin

        // --- SUPABASE CONFIG ---
        // IMPORTANT: Replace with your Supabase Project URL and Anon Key
        const SUPABASE_URL = 'https://cqfpctbyosfrpipcntik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNxZnBjdGJ5b3NmcnBpcGNudGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NTcwODYsImV4cCI6MjA2OTMzMzA4Nn0.3fR9jkM2E0AEs7Kddj5mwpd9ySF1Z8nTp6MiCVCWD6Y';


        // --- DOM ELEMENTS ---
        const elements = {
            // Modal elements
            loginModalOverlay: document.getElementById('login-modal-overlay'),
            loginModal: document.getElementById('login-modal'),
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            
            // Confirmation Modal elements
            confirmModalOverlay: document.getElementById('confirm-modal-overlay'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalText: document.getElementById('confirm-modal-text'),
            confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'),
            confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),

            // Edit Report Modal
            editReportModalOverlay: document.getElementById('edit-report-modal-overlay'),
            editReportModal: document.getElementById('edit-report-modal'),
            editReportForm: document.getElementById('edit-report-form'),
            closeEditReportModalBtn: document.getElementById('close-edit-report-modal-btn'),
            showEditReportModalBtn: document.getElementById('show-edit-report-modal-btn'),

            // Report Details Modal
            reportDetailsModalOverlay: document.getElementById('report-details-modal-overlay'),
            reportDetailsModal: document.getElementById('report-details-modal'),
            closeReportDetailsModalBtn: document.getElementById('close-report-details-modal-btn'),
            detailsReporterName: document.getElementById('details-reporter-name'),
            detailsReporterPosition: document.getElementById('details-reporter-position'),
            detailsReporterAffiliation: document.getElementById('details-reporter-affiliation'),
            detailsTransformerId: document.getElementById('details-transformer-id'),
            detailsAuthority: document.getElementById('details-authority'),
            detailsCreatedAt: document.getElementById('details-created-at'),
            detailsReportDetails: document.getElementById('details-report-details'),
            adminSuggestions: document.getElementById('admin-suggestions'),
            saveAdminSuggestionBtn: document.getElementById('save-admin-suggestion-btn'),
            analyzeReportBtn: document.getElementById('analyze-report-btn'),
            reportAiLoader: document.getElementById('report-ai-loader'),
            reportAiAnalysisContent: document.getElementById('report-ai-analysis-content'),
            generateSuggestionAiBtn: document.getElementById('generate-suggestion-ai-btn'),
            deleteReportBtn: document.getElementById('delete-report-btn'),


            // Auth elements
            adminLoginBtn: document.getElementById('admin-login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userRoleDisplay: document.getElementById('user-role-display'),

            // Admin Panel & Tabs
            adminPanel: document.getElementById('admin-panel'),
            adminConfigTab: document.getElementById('admin-config-tab'),
            adminReportsTab: document.getElementById('admin-reports-tab'),
            adminConfigSection: document.getElementById('admin-config-section'),
            adminReportsSection: document.getElementById('admin-reports-section'),
            reportsListContainer: document.getElementById('reports-list-container'),
            reportsTableBody: document.getElementById('reports-table-body'),
            noReportsMessage: document.getElementById('no-reports-message'),

            // Input elements
            transformerUrl: document.getElementById('transformer-url'),
            meterUrl: document.getElementById('meter-url'),
            authorityInput: document.getElementById('authority-input'),
            startDateInput: document.getElementById('start-date-input'),
            endDateInput: document.getElementById('end-date-input'),
            monthInput: document.getElementById('month-input'),

            // Control elements
            calculateBtn: document.getElementById('calculate-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            loadingSpinner: document.getElementById('loading-spinner'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),

            // View elements
            resultsSection: document.getElementById('results-section'),
            userWaitingMessage: document.getElementById('user-waiting-message'),
            viewAuthoritySelect: document.getElementById('view-authority-select'),
            viewTransformerSelect: document.getElementById('view-transformer-select'),
            viewMonthSelect: document.getElementById('view-month-select'),
            userViewReportFeedbackSection: document.getElementById('user-view-report-feedback-section'),
            userViewFeedbackContent: document.getElementById('user-view-feedback-content'),
            overallSummarySection: document.getElementById('overall-summary-section'),
            summaryTotalTransformers: document.getElementById('summary-total-transformers'),
            summaryTotalMeters: document.getElementById('summary-total-meters'),
            summaryEnergyOut: document.getElementById('summary-energy-out'),
            summaryEnergyIn: document.getElementById('summary-energy-in'),
            summaryTotalLoss: document.getElementById('summary-total-loss'),
            summaryLossPercent: document.getElementById('summary-loss-percent'),

            // Chart elements
            trendChart: document.getElementById('consumption-trend-chart'),
            meterChart: document.getElementById('meter-consumption-chart'),
            highestLossSection: document.getElementById('highest-loss-section'),
            highestLossChart: document.getElementById('highest-loss-chart'),

            // KPI elements
            kpiTransformerEnergy: document.getElementById('kpi-transformer-energy'),
            kpiMeterEnergy: document.getElementById('kpi-meter-energy'),
            kpiLoss: document.getElementById('kpi-loss'),
            kpiLossPercent: document.getElementById('kpi-loss-percent'),

            // Metrics elements
            metricPf: document.getElementById('metric-pf'),
            metricPeakPower: document.getElementById('metric-peak-power'),
            metricPeakDate: document.getElementById('metric-peak-date'),

            // AI Analysis elements
            aiLoader: document.getElementById('ai-analysis-loader'),
            aiContent: document.getElementById('ai-analysis-content'),
            aiError: document.getElementById('ai-analysis-error'),
            aiErrorText: document.getElementById('ai-error-text'),
            actionButtonsContainer: document.getElementById('action-buttons-container'),
            generateActionPlanBtn: document.getElementById('generate-action-plan-btn'),
            
            // Action Plan elements
            actionPlanSection: document.getElementById('action-plan-section'),
            actionPlanLoader: document.getElementById('action-plan-loader'),
            actionPlanContent: document.getElementById('action-plan-content'),
            actionPlanError: document.getElementById('action-plan-error'),
            actionPlanErrorText: document.getElementById('action-plan-error-text'),

            // Table elements
            resultsTable: document.getElementById('results-table')
        };

        // --- UTILITY FUNCTIONS ---
        function showElement(element) {
            if (element) element.classList.remove('hidden');
        }

        function hideElement(element) {
            if (element) element.classList.add('hidden');
        }

        function toggleElement(element, show) {
            if (show) showElement(element);
            else hideElement(element);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
            errorDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                errorDiv.classList.add('translate-x-full');
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);
        }

        function clearError() {
            hideElement(elements.errorMessage);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
            successDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                successDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }, 3000);
        }

        // --- MODAL FUNCTIONS ---
        function showModal(overlay, modal) {
            showElement(overlay);
            showElement(modal);
            setTimeout(() => {
                overlay.classList.add('show');
                modal.classList.add('show');
            }, 10);
        }

        function hideModal(overlay, modal) {
            overlay.classList.remove('show');
            modal.classList.remove('show');
            setTimeout(() => {
                hideElement(overlay);
                hideElement(modal);
            }, 300);
        }
        
        function showLoginModal() {
            if (elements.loginError) elements.loginError.textContent = '';
            hideElement(elements.loginError);
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showModal(elements.loginModalOverlay, elements.loginModal);
            setTimeout(() => document.getElementById('username').focus(), 100);
        }

        function hideLoginModal() {
            hideModal(elements.loginModalOverlay, elements.loginModal);
        }

        function showEditReportModal() {
            elements.editReportForm.reset();
            showModal(elements.editReportModalOverlay, elements.editReportModal);
        }

        function hideEditReportModal() {
            hideModal(elements.editReportModalOverlay, elements.editReportModal);
        }

        async function showReportDetailsModal(report) {
            currentReportId = report.id;
            elements.detailsReporterName.textContent = report.reporter_name;
            elements.detailsReporterPosition.textContent = report.reporter_position;
            elements.detailsReporterAffiliation.textContent = report.reporter_affiliation;
            elements.detailsTransformerId.textContent = report.transformer_id;
            elements.detailsAuthority.textContent = report.authority;
            elements.detailsCreatedAt.textContent = new Date(report.created_at).toLocaleString('th-TH');
            elements.detailsReportDetails.textContent = report.report_details;
            elements.adminSuggestions.value = report.admin_suggestions || '';
            elements.reportAiAnalysisContent.innerHTML = report.ai_report_analysis ? marked.parse(report.ai_report_analysis) : '<p class="text-gray-500">ยังไม่มีการวิเคราะห์รายงานนี้</p>';
            hideElement(elements.reportAiLoader);
            showModal(elements.reportDetailsModalOverlay, elements.reportDetailsModal);
        }

        function hideReportDetailsModal() {
            hideModal(elements.reportDetailsModalOverlay, elements.reportDetailsModal);
            currentReportId = null;
        }
        
        function showConfirmModal({ title, text, onConfirm }) {
            elements.confirmModalTitle.textContent = title;
            elements.confirmModalText.textContent = text;
            
            const confirmHandler = () => {
                onConfirm();
                hideConfirmModal();
            };
            
            elements.confirmModalConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            showModal(elements.confirmModalOverlay, elements.confirmModal);
        }

        function hideConfirmModal() {
            hideModal(elements.confirmModalOverlay, elements.confirmModal);
        }


        // --- AUTH & DATA FUNCTIONS ---
        function renderAppForRole() {
            const isAdmin = currentUser.role === 'admin';
            elements.userRoleDisplay.textContent = isAdmin ? 'Administrator' : 'ผู้ใช้งาน';

            toggleElement(elements.adminLoginBtn, !isAdmin);
            toggleElement(elements.logoutBtn, isAdmin);
            toggleElement(elements.adminPanel, isAdmin);

            document.querySelectorAll('.admin-only').forEach(el =>
                toggleElement(el, isAdmin)
            );
            
            toggleElement(elements.deleteBtn, isAdmin && analysisDone);


            if (analysisDone) {
                showElement(elements.resultsSection);
                showElement(elements.overallSummarySection);
                showElement(elements.highestLossSection);
                hideElement(elements.userWaitingMessage);
            } else {
                hideElement(elements.resultsSection);
                hideElement(elements.overallSummarySection);
                hideElement(elements.highestLossSection);
                showElement(elements.userWaitingMessage);
            }
        }
        
        async function fetchAndProcessInitialData() {
            const { data, error } = await supabase.from('analysis').select('*');
            if (error) {
                console.error("Error fetching initial data:", error);
                showError("ไม่สามารถดึงข้อมูลเริ่มต้นได้");
                return;
            }

            const allData = {};
            let hasData = false;
            data.forEach(row => {
                const analysisData = row.data;
                if (!allData[analysisData.authority]) {
                    allData[analysisData.authority] = {};
                }
                const transformerKey = analysisData.mappings.map(m => m.transformerId).join('_');
                const month = row.doc_id.split('_').pop();
                 if (!allData[analysisData.authority][transformerKey]) {
                    allData[analysisData.authority][transformerKey] = {};
                }
                allData[analysisData.authority][transformerKey][month] = analysisData;
                hasData = true;
            });
            
            allAnalysisData = allData;
            console.log("Initial data processed:", allAnalysisData);

            calculateAndDisplayOverallSummary(allAnalysisData);

            if (hasData) {
                analysisDone = true;
                populateSelectors(allAnalysisData);
                
                const authorities = Object.keys(allAnalysisData).sort();
                const latestAuthority = authorities[authorities.length - 1];
                elements.viewAuthoritySelect.value = latestAuthority;
                
                populateTransformerSelector(allAnalysisData, latestAuthority);
                const transformers = Object.keys(allAnalysisData[latestAuthority] || {}).sort();
                const latestTransformer = transformers.length > 0 ? transformers[transformers.length - 1] : '';
                elements.viewTransformerSelect.value = latestTransformer;

                populateMonthSelector(allAnalysisData, latestAuthority, latestTransformer);
                const months = Object.keys(allAnalysisData[latestAuthority]?.[latestTransformer] || {}).sort();
                const latestMonth = months.length > 0 ? months[months.length - 1] : '';
                elements.viewMonthSelect.value = latestMonth;
                
                loadSelectedData(allAnalysisData);
            } else {
                analysisDone = false;
            }
            renderAppForRole();
            setupSelectorListeners(allAnalysisData);
        }

        // --- DATA PROCESSING FUNCTIONS ---
        function findKey(obj, possibleKeys) {
            if (!obj) return null;
            const objKeys = Object.keys(obj);
            for (const key of possibleKeys) {
                const foundKey = objKeys.find(k => k.trim().toLowerCase() === key.toLowerCase());
                if (foundKey) return foundKey;
            }
            return null;
        }

        function parseDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            const trimmedDate = dateString.trim();
            const parts = trimmedDate.split(/[-/]/);
            if (parts.length === 3) {
                if (parts[0].length === 4) { // YYYY-MM-DD
                    return new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
                }
                if (parts[2].length === 4) { // DD-MM-YYYY
                    return new Date(Date.UTC(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])));
                }
            }
            const d = new Date(trimmedDate);
            if (!isNaN(d.getTime())) return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            return null;
        }

        function transformGoogleSheetUrl(url) {
            let sheetId, gid;
            const idMatch = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (idMatch && idMatch[1]) {
                sheetId = idMatch[1];
            } else {
                throw new Error('รูปแบบ Google Sheet URL ไม่ถูกต้อง ไม่พบ Sheet ID ในลิงก์');
            }
            const gidMatch = url.match(/[#&?]gid=([0-9]+)/);
            if (gidMatch && gidMatch[1]) {
                gid = gidMatch[1];
            } else {
                gid = '0';
            }
            return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
        }

        async function fetchDataFromGoogleSheet(url, keywords) {
            const csvUrl = transformGoogleSheetUrl(url);
            const response = await fetch(csvUrl);
            if (!response.ok) {
                throw new Error(`ไม่สามารถดึงข้อมูลจาก Google Sheet ได้ (Status: ${response.status}) ตรวจสอบว่าลิงก์ถูกต้องและตั้งค่าการแชร์เป็น "ทุกคนที่มีลิงก์"`);
            }
            const csvText = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: false,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            const dataArray = results.data;
                            if (dataArray.length < 2) throw new Error("ไฟล์ข้อมูลว่างเปล่าหรือมีข้อมูลไม่เพียงพอ");

                            let headerIndex = -1;
                            for (let i = 0; i < dataArray.length; i++) {
                                const row = dataArray[i];
                                const foundKeywords = keywords.filter(kw => row.some(cell => cell && cell.trim().toLowerCase() === kw.toLowerCase()));
                                if (foundKeywords.length >= 2) {
                                    headerIndex = i;
                                    break;
                                }
                            }

                            if (headerIndex === -1) throw new Error(`ไม่พบหัวตารางที่ถูกต้องในไฟล์ (ต้องมีคอลัมน์ เช่น: ${keywords.join(', ')})`);

                            const header = dataArray[headerIndex].map(h => h.trim());
                            const dataRows = dataArray.slice(headerIndex + 1);

                            const jsonData = dataRows.map(row => {
                                const obj = {};
                                header.forEach((key, i) => {
                                    obj[key] = row[i];
                                });
                                return obj;
                            }).filter(obj => Object.values(obj).some(val => val !== null && val !== ''));

                            resolve(jsonData);
                        } catch (e) {
                            reject(e);
                        }
                    },
                    error: (error) => reject(new Error(`เกิดข้อผิดพลาดในการอ่านข้อมูล CSV: ${error.message}`))
                });
            });
        }

        // --- CALCULATION FUNCTIONS ---
        function validateInputs() {
            const transformerUrlValid = validateGoogleSheetUrl(elements.transformerUrl.value.trim());
            const meterUrlValid = validateGoogleSheetUrl(elements.meterUrl.value.trim());
            const hasUrls = transformerUrlValid && meterUrlValid;
            const hasParams = elements.authorityInput.value.trim() && elements.startDateInput.value && elements.endDateInput.value && elements.monthInput.value;
            const hasMappings = transformerMeterMappings.length > 0;

            elements.calculateBtn.disabled = !(hasUrls && hasParams && hasMappings);
        }

        async function calculateLoss() {
            console.log('Calculate button clicked');

            try {
                elements.calculateBtn.disabled = true;
                showElement(elements.loadingSpinner);
                clearError();

                const mappings = transformerMeterMappings;
                if (mappings.length === 0) {
                    throw new Error('ยังไม่ได้ทำการจับคู่หม้อแปลงและมิเตอร์ กรุณากดปุ่ม "ตรวจสอบการจับคู่" ก่อน');
                }

                console.log('Starting data fetch...');

                const [transformerData, meterData] = await Promise.all([
                    fetchDataFromGoogleSheet(elements.transformerUrl.value, ['วันที่', 'KWH_TOT', 'PF_TOT', 'P_TOT']),
                    fetchDataFromGoogleSheet(elements.meterUrl.value, ['PEA Meter', 'หม้อแปลง', 'KWH_JAN'])
                ]);

                console.log('Data fetched:', {
                    transformerCount: transformerData.length,
                    meterCount: meterData.length
                });

                if (!transformerData.length || !meterData.length) {
                    throw new Error("ข้อมูลหม้อแปลงหรือมิเตอร์ว่างเปล่า");
                }

                const startDate = parseDate(elements.startDateInput.value);
                const endDate = parseDate(elements.endDateInput.value);
                const selectedMonthStr = elements.monthInput.value;
                const authorityName = elements.authorityInput.value.trim();

                console.log('Parameters:', {
                    startDate,
                    endDate,
                    selectedMonthStr,
                    authorityName
                });

                if (!startDate || !endDate) throw new Error('รูปแบบวันที่ไม่ถูกต้อง');
                if (startDate > endDate) throw new Error('วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด');

                const selectedMonth = new Date(selectedMonthStr + '-02T00:00:00Z').getUTCMonth();
                const monthKeys = ['KWH_JAN', 'KWH_FEB', 'KWH_MAR', 'KWH_APR', 'KWH_MAY', 'KWH_JUN', 'KWH_JUL', 'KWH_AUG', 'KWH_SEP', 'KWH_OCT', 'KWH_NOV', 'KWH_DEC'];

                console.log('Selected month:', selectedMonth, monthKeys[selectedMonth]);

                const results = [];
                let totalTransformerEnergy = 0;
                let totalMeterEnergy = 0;
                let meterBreakdown = [];

                for (const mapping of mappings) {
                    console.log('Processing mapping:', mapping);

                    try {
                        const transformerResult = await processTransformerData(transformerData, mapping.transformerId, startDate, endDate);
                        const meterResult = await processMeterData(meterData, mapping.meterIds, selectedMonth, monthKeys);

                        console.log('Results for', mapping.transformerId, {
                            transformerEnergy: transformerResult.energy,
                            meterEnergy: meterResult.totalEnergy
                        });

                        const loss = transformerResult.energy - meterResult.totalEnergy;
                        const lossPercent = transformerResult.energy > 0 ? (loss / transformerResult.energy) * 100 : 0;

                        results.push({
                            transformerId: mapping.transformerId,
                            transformerEnergy: transformerResult.energy,
                            sumOfMeterEnergy: meterResult.totalEnergy,
                            loss: loss,
                            lossPercent: lossPercent,
                            meterIds: mapping.meterIds,
                            meterBreakdown: meterResult.breakdown
                        });

                        totalTransformerEnergy += transformerResult.energy;
                        totalMeterEnergy += meterResult.totalEnergy;
                        meterBreakdown = meterBreakdown.concat(meterResult.breakdown);
                    } catch (mapError) {
                        console.error('Error processing mapping:', mapping.transformerId, mapError);
                        throw new Error(`ข้อผิดพลาดในการประมวลผลหม้อแปลง ${mapping.transformerId}: ${mapError.message}`);
                    }
                }

                const keyMetrics = calculateKeyMetrics(transformerData, startDate, endDate);
                const totalLoss = totalTransformerEnergy - totalMeterEnergy;

                console.log('Final results:', {
                    totalTransformerEnergy,
                    totalMeterEnergy,
                    totalLoss,
                    resultsCount: results.length
                });

                const dataToSave = {
                    results,
                    totalLoss,
                    totalTransformerEnergy,
                    totalMeterEnergy,
                    transformerCount: mappings.length,
                    meterCount: meterBreakdown.length,
                    meterBreakdown,
                    authority: authorityName,
                    avgPF: keyMetrics.avgPF,
                    peakPower: keyMetrics.peakPower,
                    peakPowerDate: keyMetrics.peakPowerDate,
                    mappings: mappings,
                    lastUpdated: new Date().toISOString()
                };
                
                const docId = `${authorityName}_${mappings.map(m => m.transformerId).join('_')}_${selectedMonthStr}`;
                
                const { error } = await supabase
                    .from('analysis')
                    .upsert({ doc_id: docId, data: dataToSave }, { onConflict: 'doc_id' });

                if (error) throw error;

                console.log('Data saved to Supabase successfully');

                showSuccess(`วิเคราะห์เสร็จสิ้น! พบ ${mappings.length} หม้อแปลง และ ${meterBreakdown.length} มิเตอร์`);

            } catch (error) {
                console.error('Calculate error:', error);
                showError(`เกิดข้อผิดพลาด: ${error.message}`);
                analysisDone = false;
            } finally {
                resetLoadingState();
            }
        }

        async function processTransformerData(transformerData, transformerId, startDate, endDate) {
            console.log(`🔌 Processing transformer: ${transformerId}`);

            const tDateKey = findKey(transformerData[0], ['Date', 'วันที่']);
            const tEnergyKey = findKey(transformerData[0], ['Energy_Output_kWh', 'KWH_TOT']);

            if (!tDateKey || !tEnergyKey) {
                throw new Error(`ไม่พบคอลัมน์ที่จำเป็นในไฟล์หม้อแปลง สำหรับ ${transformerId}\nต้องมี: Date/วันที่ และ KWH_TOT`);
            }

            console.log(`📅 Using date column: ${tDateKey}, energy column: ${tEnergyKey}`);

            const sortedTrData = transformerData
                .map(row => ({
                    ...row,
                    parsedDate: parseDate(row[tDateKey]),
                    kwh: parseFloat(row[tEnergyKey]) || 0
                }))
                .filter(row => row.parsedDate && !isNaN(row.kwh))
                .sort((a, b) => a.parsedDate - b.parsedDate);

            console.log(`📊 Sorted transformer data: ${sortedTrData.length} records`);

            const endRecord = sortedTrData.filter(row => row.parsedDate <= endDate).pop();
            const startRecord = sortedTrData.filter(row => row.parsedDate < startDate).pop() || sortedTrData.find(row => row.parsedDate >= startDate);


            if (!endRecord) {
                throw new Error(`ไม่พบข้อมูล KWH_TOT ณ วันที่สิ้นสุด (${endDate.toISOString().split('T')[0]}) สำหรับหม้อแปลง ${transformerId}`);
            }
            if (!startRecord) {
                throw new Error(`ไม่พบข้อมูล KWH_TOT ณ วันที่เริ่มต้น (${startDate.toISOString().split('T')[0]}) สำหรับหม้อแปลง ${transformerId}`);
            }

            const startKwh = parseFloat(startRecord[tEnergyKey]) || 0;
            const endKwh = parseFloat(endRecord[tEnergyKey]) || 0;
            const energy = endKwh - startKwh;

            console.log(`⚡ Transformer ${transformerId} calculation:`, {
                startDate: startRecord[tDateKey],
                endDate: endRecord[tDateKey],
                startKwh: startKwh.toFixed(2),
                endKwh: endKwh.toFixed(2),
                energyDiff: energy.toFixed(2)
            });

            if (isNaN(energy) || energy < 0) {
                console.warn(`การคำนวณพลังงานหม้อแปลง ${transformerId} ได้ผลลัพธ์ติดลบหรือผิดพลาด`, {startKwh, endKwh, energy});
            }

            return {
                energy
            };
        }

        async function processMeterData(meterData, meterIds, selectedMonth, monthKeys) {
            console.log(`📊 Processing ${meterIds.length} meters for month: ${monthKeys[selectedMonth]}`);

            const mIdKey = findKey(meterData[0], ['Meter_ID', 'PEA Meter']);
            const meterEnergyKeyForMonth = findKey(meterData[0], [monthKeys[selectedMonth]]);

            if (!mIdKey || !meterEnergyKeyForMonth) {
                throw new Error(`ไม่พบคอลัมน์ที่จำเป็นในไฟล์มิเตอร์\nต้องมี: PEA Meter/Meter_ID และ ${monthKeys[selectedMonth]}`);
            }

            console.log(`🔑 Using meter ID column: ${mIdKey}, energy column: ${meterEnergyKeyForMonth}`);

            const breakdown = [];
            let totalEnergy = 0;
            let foundMeters = 0;
            let missingMeters = [];

            for (const meterId of meterIds) {
                const meterRecord = meterData.find(row => row[mIdKey] && row[mIdKey].toString().trim() === meterId.toString().trim());

                if (meterRecord) {
                    const energy = parseFloat(meterRecord[meterEnergyKeyForMonth]) || 0;
                    breakdown.push({
                        meterId,
                        energy
                    });
                    totalEnergy += energy;
                    foundMeters++;

                    console.log(`🔌 Meter ${meterId}: ${energy.toFixed(2)} kWh`);
                } else {
                    console.warn(`⚠️ ไม่พบข้อมูลสำหรับมิเตอร์ ${meterId}`);
                    breakdown.push({
                        meterId,
                        energy: 0
                    });
                    missingMeters.push(meterId);
                }
            }

            console.log(`📈 Meter summary:`, {
                totalMeters: meterIds.length,
                foundMeters,
                missingMeters: missingMeters.length,
                totalEnergy: totalEnergy.toFixed(2)
            });

            if (missingMeters.length > 0) {
                console.warn(`⚠️ Missing meters: ${missingMeters.join(', ')}`);
            }

            return {
                totalEnergy,
                breakdown
            };
        }

        function calculateKeyMetrics(transformerData, startDate, endDate) {
            const tDateKey = findKey(transformerData[0], ['Date', 'วันที่']);
            const tPfKey = findKey(transformerData[0], ['PF_TOT']);
            const tPowerKey = findKey(transformerData[0], ['P_TOT']);

            const rangeData = transformerData
                .map(row => ({ ...row,
                    parsedDate: parseDate(row[tDateKey])
                }))
                .filter(row => row.parsedDate && row.parsedDate >= startDate && row.parsedDate <= endDate);

            let avgPF = 0,
                peakPower = 0,
                peakPowerDate = '-';

            if (rangeData.length > 0) {
                avgPF = rangeData.reduce((sum, row) => sum + (parseFloat(row[tPfKey]) || 0), 0) / rangeData.length;

                let peakRecord = rangeData[0];
                for (const row of rangeData) {
                    if ((parseFloat(row[tPowerKey]) || 0) > (parseFloat(peakRecord[tPowerKey]) || 0)) {
                        peakRecord = row;
                    }
                }
                peakPower = parseFloat(peakRecord[tPowerKey]) || 0;
                peakPowerDate = peakRecord[tDateKey];
            }

            return {
                avgPF,
                peakPower,
                peakPowerDate
            };
        }

        function resetLoadingState() {
            hideElement(elements.loadingSpinner);
            validateInputs();
        }

        // --- DISPLAY FUNCTIONS ---
        async function displayResults(data) {
            // Hide action plan and feedback from previous results
            hideElement(elements.actionPlanSection);
            hideElement(elements.actionButtonsContainer);
            
            elements.kpiTransformerEnergy.textContent = data.totalTransformerEnergy.toLocaleString('en-US', {
                maximumFractionDigits: 2
            });
            elements.kpiMeterEnergy.textContent = data.totalMeterEnergy.toLocaleString('en-US', {
                maximumFractionDigits: 2
            });
            elements.kpiLoss.textContent = data.totalLoss.toLocaleString('en-US', {
                maximumFractionDigits: 2
            });

            const avgLossPercent = data.totalTransformerEnergy > 0 ? (data.totalLoss / data.totalTransformerEnergy) * 100 : 0;
            elements.kpiLossPercent.textContent = `${avgLossPercent.toFixed(2)}%`;

            updateKeyMetrics(data);
            updateResultsTable(data);
            renderCharts(data);
            await getAiAnalysis(data.results, avgLossPercent);
        }

        function calculateAndDisplayOverallSummary(allData) {
            let totalTransformers = 0;
            let totalMeters = 0;
            let totalEnergyOut = 0;
            let totalEnergyIn = 0;
            const uniqueTransformers = new Set();

            for (const authority in allData) {
                for (const transformerKey in allData[authority]) {
                    if (uniqueTransformers.has(transformerKey)) continue;
                    uniqueTransformers.add(transformerKey);

                    const transformerHistory = allData[authority][transformerKey];
                    const sortedMonths = Object.keys(transformerHistory).sort();
                    if (sortedMonths.length > 0) {
                        const latestMonth = sortedMonths[sortedMonths.length - 1];
                        const latestData = transformerHistory[latestMonth];
                        
                        totalTransformers += latestData.transformerCount || 0;
                        totalMeters += latestData.meterCount || 0;
                        totalEnergyOut += latestData.totalTransformerEnergy || 0;
                        totalEnergyIn += latestData.totalMeterEnergy || 0;
                    }
                }
            }

            const totalLoss = totalEnergyOut - totalEnergyIn;
            const lossPercent = totalEnergyOut > 0 ? (totalLoss / totalEnergyOut) * 100 : 0;

            elements.summaryTotalTransformers.textContent = totalTransformers.toLocaleString();
            elements.summaryTotalMeters.textContent = totalMeters.toLocaleString();
            elements.summaryEnergyOut.textContent = totalEnergyOut.toLocaleString('en-US', { maximumFractionDigits: 0 });
            elements.summaryEnergyIn.textContent = totalEnergyIn.toLocaleString('en-US', { maximumFractionDigits: 0 });
            elements.summaryTotalLoss.textContent = totalLoss.toLocaleString('en-US', { maximumFractionDigits: 0 });
            elements.summaryLossPercent.textContent = `${lossPercent.toFixed(2)}%`;

            // Call the new function to render the highest loss chart
            renderHighestLossChart(allData);
        }

        function updateKeyMetrics(data) {
            elements.metricPf.textContent = data.avgPF.toFixed(2);
            elements.metricPf.className = 'text-2xl font-bold ';

            if (data.avgPF >= 0.95) elements.metricPf.classList.add('text-green-600');
            else if (data.avgPF >= 0.90) elements.metricPf.classList.add('text-yellow-500');
            else elements.metricPf.classList.add('text-red-500');

            elements.metricPeakPower.textContent = `${data.peakPower.toLocaleString('en-US', { maximumFractionDigits: 2 })} kW`;
            elements.metricPeakDate.textContent = data.peakPowerDate;
        }

        function updateResultsTable(data) {
            if (!elements.resultsTable) return;

            elements.resultsTable.innerHTML = '';
            data.results.forEach(res => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';

                let statusClass = '';
                let statusText = '';

                if (res.lossPercent > 10) {
                    statusClass = 'status-error';
                    statusText = 'สูง';
                } else if (res.lossPercent > 5) {
                    statusClass = 'status-warning';
                    statusText = 'ปานกลาง';
                } else {
                    statusClass = 'status-success';
                    statusText = 'ปกติ';
                }

                row.innerHTML = `
                    <td class="font-medium">${res.transformerId}</td>
                    <td>${res.transformerEnergy.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
                    <td>${res.sumOfMeterEnergy.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
                    <td>${res.loss.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
                    <td><span class="font-bold">${res.lossPercent.toFixed(2)}%</span></td>
                    <td><span class="status-indicator ${statusClass}">${statusText}</span></td>
                    <td class="text-sm">${res.meterIds.join(', ')}</td>
                `;

                elements.resultsTable.appendChild(row);
            });
        }

        // --- CHART FUNCTIONS ---
        function renderCharts(data) {
            renderTrendChart(data);
            renderMeterChart(data);
        }

        function renderHighestLossChart(allData) {
            const latestLossData = [];

            for (const authority in allData) {
                for (const transformerKey in allData[authority]) { // transformerKey is the composite key
                    const transformerHistory = allData[authority][transformerKey];
                    const sortedMonths = Object.keys(transformerHistory).sort();

                    if (sortedMonths.length > 0) {
                        const latestMonth = sortedMonths[sortedMonths.length - 1];
                        const latestDataForGroup = transformerHistory[latestMonth];

                        if (latestDataForGroup && latestDataForGroup.results) {
                            latestDataForGroup.results.forEach(result => {
                                latestLossData.push({
                                    transformerId: result.transformerId,
                                    lossPercent: result.lossPercent,
                                    authority: authority
                                });
                            });
                        }
                    }
                }
            }

            const uniqueLossData = Array.from(new Map(latestLossData.map(item => [item.transformerId, item])).values());

            const topTenLoss = uniqueLossData
                .sort((a, b) => b.lossPercent - a.lossPercent)
                .slice(0, 10);

            if (charts.highestLoss) {
                charts.highestLoss.destroy();
            }

            if (topTenLoss.length === 0) {
                elements.highestLossChart.innerHTML = '<div class="text-center py-10 text-gray-500">ไม่มีข้อมูลเพียงพอสำหรับแสดงกราฟ</div>';
                return;
            }

            const options = {
                series: [{
                    name: 'Loss (%)',
                    data: topTenLoss.map(d => d.lossPercent.toFixed(2))
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    toolbar: { show: true }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '60%',
                        borderRadius: 5,
                    },
                },
                dataLabels: { enabled: false },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: topTenLoss.map(d => `${d.transformerId}`),
                    title: { text: 'รหัสหม้อแปลง' }
                },
                yaxis: {
                    title: { text: 'เปอร์เซ็นต์ Loss (%)' }
                },
                fill: {
                    opacity: 1,
                    colors: ['#ef4444'] // Red color for loss
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " %"
                        }
                    },
                    x: {
                        formatter: function(val, { dataPointIndex }) {
                            const transformer = topTenLoss[dataPointIndex];
                            return `หม้อแปลง: ${transformer.transformerId} (${transformer.authority})`;
                        }
                    }
                },
                 grid: {
                    borderColor: '#f1f5f9',
                    strokeDashArray: 3
                }
            };

            charts.highestLoss = new ApexCharts(elements.highestLossChart, options);
            charts.highestLoss.render();
        }

        function renderTrendChart(data) {
            const selectedAuthority = elements.viewAuthoritySelect.value;
            const selectedTransformer = elements.viewTransformerSelect.value;

            const transformerHistory = (allAnalysisData[selectedAuthority] && allAnalysisData[selectedAuthority][selectedTransformer]) || {};
            const sortedMonths = Object.keys(transformerHistory).sort();

            const trendData = sortedMonths.map(month => {
                const monthData = transformerHistory[month];
                return {
                    month: month,
                    transformer: monthData.totalTransformerEnergy,
                    meters: monthData.totalMeterEnergy
                };
            });

            if (charts.trend) charts.trend.destroy();

            const trendOptions = {
                series: [{
                    name: 'พลังงานหม้อแปลง (kWh)',
                    data: trendData.map(m => m.transformer.toFixed(2))
                }, {
                    name: 'ผลรวมพลังงานมิเตอร์ (kWh)',
                    data: trendData.map(m => m.meters.toFixed(2))
                }],
                chart: {
                    type: 'line',
                    height: 350,
                    toolbar: {
                        show: true
                    },
                    zoom: {
                        enabled: false
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: [4, 4]
                },
                xaxis: {
                    categories: trendData.map(m => m.month),
                    title: {
                        text: 'เดือน'
                    }
                },
                yaxis: {
                    title: {
                        text: 'พลังงาน (kWh)'
                    }
                },
                tooltip: {
                    y: {
                        formatter: (val) => parseFloat(val).toLocaleString('en-US', {
                            maximumFractionDigits: 2
                        }) + " kWh"
                    }
                },
                colors: ['#3b82f6', '#10b981'],
                markers: {
                    size: 6,
                    strokeWidth: 2,
                    fillOpacity: 1,
                    strokeOpacity: 1
                },
                grid: {
                    borderColor: '#f1f5f9',
                    strokeDashArray: 3
                }
            };

            charts.trend = new ApexCharts(elements.trendChart, trendOptions);
            charts.trend.render();
        }

        function renderMeterChart(data) {
            const sortedMeters = [...data.meterBreakdown].sort((a, b) => b.energy - a.energy);
            const topMeters = sortedMeters.slice(0, 10);
            const otherMeters = sortedMeters.slice(10);
            const otherMetersSum = otherMeters.reduce((sum, m) => sum + m.energy, 0);

            const chartData = [...topMeters];
            if (otherMeters.length > 0) {
                chartData.push({
                    meterId: `มิเตอร์อื่นๆ (${otherMeters.length} ตัว)`,
                    energy: otherMetersSum
                });
            }

            if (charts.meter) charts.meter.destroy();

            const meterOptions = {
                series: [{
                    name: 'Energy (kWh)',
                    data: chartData.map(m => m.energy)
                }],
                chart: {
                    type: 'bar',
                    height: 450,
                    toolbar: {
                        show: true
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 8,
                        barHeight: '60%',
                        distributed: true
                    }
                },
                colors: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#F97316', '#EC4899', '#6366F1', '#D946EF', '#64748B'],
                dataLabels: {
                    enabled: false
                },
                legend: {
                    show: false
                },
                xaxis: {
                    categories: chartData.map(m => m.meterId),
                    title: {
                        text: 'พลังงาน (kWh)'
                    },
                    labels: {
                        formatter: (val) => val ? parseFloat(val).toLocaleString('en-US', {
                            maximumFractionDigits: 0
                        }) + " kWh" : '0'
                    }
                },
                yaxis: {
                    labels: {
                        show: true,
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: (val) => parseFloat(val).toLocaleString('en-US', {
                            maximumFractionDigits: 2
                        }) + " kWh"
                    }
                },
                grid: {
                    borderColor: '#f1f5f9'
                }
            };

            charts.meter = new ApexCharts(elements.meterChart, meterOptions);
            charts.meter.render();
        }

        // --- AI ANALYSIS & ACTION PLAN (GEMINI API) ---
        async function callGeminiAPI(prompt, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "AIzaSyDwU3rcd0Lr5hS9BsBPcIXitu5YL-IEONQ";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 503) {
                        throw new Error(`API Error: ${response.status} The model is overloaded.`);
                    }

                    if (!response.ok) {
                         const errorBody = await response.text();
                         console.error("API Error Body:", errorBody);
                         throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error("Unexpected AI response structure:", result);
                        if(result.promptFeedback && result.promptFeedback.blockReason){
                             throw new Error(`AI request blocked: ${result.promptFeedback.blockReason}`);
                        }
                        throw new Error("ไม่ได้รับผลลัพธ์ที่ถูกต้องจาก AI");
                    }
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed: ${error.message}. Retrying in ${delay / 1000}s...`);
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function getAiAnalysis(results, avgLossPercent) {
            showElement(elements.aiLoader);
            hideElement(elements.aiContent);
            hideElement(elements.aiError);
            hideElement(elements.actionButtonsContainer);
            hideElement(elements.actionPlanSection);

            currentDataSummary = results.map(r =>
                `- หม้อแปลง ${r.transformerId} (มิเตอร์: ${r.meterIds.length} ตัว): Loss ${r.lossPercent.toFixed(2)}%`
            ).join('\n');

            const prompt = `ในฐานะผู้เชี่ยวชาญด้านระบบไฟฟ้า, จากข้อมูลค่า Loss ต่อไปนี้:

${currentDataSummary}

Loss เฉลี่ยรวม: ${avgLossPercent.toFixed(2)}%

โปรดวิเคราะห์และสรุปประเด็นสำคัญ:
1.  **ภาพรวม:** สถานการณ์โดยรวมเป็นอย่างไร
2.  **หม้อแปลงที่น่าเป็นห่วง:** ระบุหม้อแปลงที่น่าเป็นห่วงที่สุด
3.  **การสูญเสียทางเทคนิค (Technical Loss):** ประเมินความเป็นไปได้ของ Loss ที่เกิดจากปัจจัยทางเทคนิค (เช่น อุปกรณ์, สายส่ง)
4.  **การสูญเสียที่ไม่ใช่ทางเทคนิค (Non-technical Loss):** ประเมินความเป็นไปได้ของ Loss ที่เกิดจากปัจจัยอื่นๆ (เช่น การลักลอบใช้ไฟ, มิเตอร์ผิดพลาด)
5.  **ข้อเสนอแนะเร่งด่วน:** สิ่งที่ควรทำเป็นอันดับแรกคืออะไร

ใช้ภาษาไทย, สรุปให้กระชับ และจัดรูปแบบด้วย Markdown`;

            try {
                currentAnalysisText = await callGeminiAPI(prompt);
                elements.aiContent.innerHTML = marked.parse(currentAnalysisText);
                showElement(elements.aiContent);
                showElement(elements.actionButtonsContainer);
            } catch (error) {
                console.error("AI Analysis Error:", error);
                elements.aiErrorText.textContent = `เกิดข้อผิดพลาดในการวิเคราะห์: ${error.message}`;
                showElement(elements.aiError);
            } finally {
                hideElement(elements.aiLoader);
            }
        }

        async function generateActionPlan() {
            showElement(elements.actionPlanSection);
            showElement(elements.actionPlanLoader);
            hideElement(elements.actionPlanContent);
            hideElement(elements.actionPlanError);
            elements.generateActionPlanBtn.disabled = true;

            const prompt = `จากบทวิเคราะห์ AI:
---
${currentAnalysisText}
---
และอ้างอิงตาม "แบบฟอร์มการตรวจหม้อแปลง (มป.3)" ซึ่งมีรายการตรวจสอบดังนี้:
- ค่าฉนวน (น้ำมัน, ขดลวด)
- ค่า Ground
- การตรวจสอบอุปกรณ์ประกอบ (ตัวถัง, Bushing, Tap Changer, Arcing Horn, ล่อฟ้า, ฟิวส์)
- การตรวจเปลี่ยนและเติมน้ำมัน (ระดับน้ำมัน, สารดูดความชื้น, ปะเก็น)
- การตรวจสอบสภาพรับโหลด (กระแส, แรงดัน)

โปรดสร้าง "แผนปฏิบัติการ" (Action Plan) ที่เป็นรูปธรรมสำหรับทีมช่างไฟฟ้า โดยเลือกรายการที่เกี่ยวข้องที่สุดจากแบบฟอร์มการตรวจฯ มาสร้างเป็นแผน จัดรูปแบบเป็นตาราง Markdown ที่มีคอลัมน์: "งานที่ต้องทำ (จากแบบฟอร์ม มป.3)", "หม้อแปลงเป้าหมาย", และ "ความสำคัญ (สูง/กลาง/ต่ำ)"`;

            try {
                const actionPlanText = await callGeminiAPI(prompt);
                elements.actionPlanContent.innerHTML = marked.parse(actionPlanText);
                showElement(elements.actionPlanContent);
            } catch (error) {
                console.error("Action Plan Error:", error);
                elements.actionPlanErrorText.textContent = `เกิดข้อผิดพลาดในการสร้างแผน: ${error.message}`;
                showElement(elements.actionPlanError);
            } finally {
                hideElement(elements.actionPlanLoader);
                elements.generateActionPlanBtn.disabled = false;
            }
        }


        // --- SELECTOR FUNCTIONS ---
        function populateSelectors(allData) {
            const authorities = Object.keys(allData).sort();

            elements.viewAuthoritySelect.innerHTML = '<option value="">-- เลือกการไฟฟ้า --</option>';
            authorities.forEach(auth => {
                const option = document.createElement('option');
                option.value = auth;
                option.textContent = auth;
                elements.viewAuthoritySelect.appendChild(option);
            });
        }

        function populateTransformerSelector(allData, selectedAuthority) {
            const transformers = selectedAuthority ? Object.keys(allData[selectedAuthority] || {}).sort() : [];

            elements.viewTransformerSelect.innerHTML = '<option value="">-- เลือกหม้อแปลง --</option>';
            transformers.forEach(tr => {
                const option = document.createElement('option');
                option.value = tr;
                option.textContent = tr;
                elements.viewTransformerSelect.appendChild(option);
            });
        }

        function populateMonthSelector(allData, selectedAuthority, selectedTransformer) {
            let months = [];
            if (selectedAuthority && selectedTransformer && allData[selectedAuthority] && allData[selectedAuthority][selectedTransformer]) {
                months = Object.keys(allData[selectedAuthority][selectedTransformer] || {}).sort().reverse();
            }

            elements.viewMonthSelect.innerHTML = '<option value="">-- เลือกเดือน --</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                elements.viewMonthSelect.appendChild(option);
            });
        }

        async function loadSelectedData(allData) {
            const selectedAuthority = elements.viewAuthoritySelect.value;
            const selectedTransformer = elements.viewTransformerSelect.value;
            const selectedMonth = elements.viewMonthSelect.value;

            if (selectedAuthority && selectedTransformer && selectedMonth) {
                let data = null;
                if (allData[selectedAuthority] && allData[selectedAuthority][selectedTransformer]) {
                    data = allData[selectedAuthority][selectedTransformer][selectedMonth];
                }
                if (data) {
                    analysisDone = true;
                    renderAppForRole();
                    await displayResults(data);
                } else {
                    // This can happen if selectors change and the specific month doesn't exist for the new selection
                    analysisDone = false;
                    renderAppForRole();
                }
            } else {
                 analysisDone = Object.keys(allData).length > 0;
                 renderAppForRole();
            }
        }
        
        async function deleteCurrentAnalysis() {
            const selectedAuthority = elements.viewAuthoritySelect.value;
            const selectedTransformer = elements.viewTransformerSelect.value;
            const selectedMonth = elements.viewMonthSelect.value;

            if (!selectedAuthority || !selectedTransformer || !selectedMonth) {
                showError("กรุณาเลือกข้อมูลที่ต้องการลบให้ครบถ้วน");
                return;
            }

            const docId = `${selectedAuthority}_${selectedTransformer}_${selectedMonth}`;
            
            showConfirmModal({
                title: "ยืนยันการลบข้อมูล",
                text: `คุณต้องการลบข้อมูลการวิเคราะห์ของเดือน ${selectedMonth} สำหรับ ${selectedAuthority} ใช่หรือไม่?`,
                onConfirm: async () => {
                    console.log(`Deleting from Supabase with id: ${docId}`);
                    try {
                        const { error } = await supabase
                            .from('analysis')
                            .delete()
                            .eq('doc_id', docId);

                        if (error) throw error;
                        
                        showSuccess("ลบข้อมูลสำเร็จแล้ว");
                        // The onSnapshot listener will automatically update the UI.
                    } catch (error) {
                        console.error("Error deleting document:", error);
                        showError(`เกิดข้อผิดพลาดในการลบข้อมูล: ${error.message}`);
                    }
                }
            });
        }


        // --- AUTO-MAPPING FUNCTION ---
        async function detectMappingsFromUrls() {
            const detectBtn = document.getElementById('detect-mappings-btn');
            const detectBtnText = document.getElementById('detect-btn-text');
            const detectedMappingsDiv = document.getElementById('detected-mappings');

            detectBtn.disabled = true;
            if (detectBtnText) detectBtnText.textContent = 'กำลังตรวจสอบ...';
            detectedMappingsDiv.innerHTML = '<div class="text-blue-600 text-sm">กำลังโหลดข้อมูลมิเตอร์เพื่อตรวจสอบการจับคู่...</div>';
            clearError();

            try {
                const meterUrl = elements.meterUrl.value.trim();
                if (!validateGoogleSheetUrl(meterUrl)) {
                    throw new Error('ลิงก์ Google Sheets ของไฟล์มิเตอร์ไม่ถูกต้อง');
                }

                const meterData = await fetchDataFromGoogleSheet(meterUrl, ['PEA Meter', 'หม้อแปลง']);

                const mTransformerKey = findKey(meterData[0], ['หม้อแปลง', 'transformer']);
                const mIdKey = findKey(meterData[0], ['PEA Meter', 'meter id']);

                if (!mTransformerKey || !mIdKey) {
                    throw new Error('ไม่พบคอลัมน์ "หม้อแปลง" หรือ "PEA Meter" ในไฟล์ข้อมูลมิเตอร์');
                }

                const mappings = meterData.reduce((acc, row) => {
                    const transformerId = row[mTransformerKey] ? row[mTransformerKey].trim() : null;
                    const meterId = row[mIdKey] ? row[mIdKey].trim() : null;

                    if (transformerId && meterId) {
                        if (!acc[transformerId]) {
                            acc[transformerId] = {
                                transformerId: transformerId,
                                meterIds: []
                            };
                        }
                        acc[transformerId].meterIds.push(meterId);
                    }
                    return acc;
                }, {});

                transformerMeterMappings = Object.values(mappings);

                if (transformerMeterMappings.length === 0) {
                    detectedMappingsDiv.innerHTML = '<div class="text-red-600 text-sm">ไม่พบการจับคู่ที่ถูกต้องในไฟล์</div>';
                    throw new Error('ไม่พบข้อมูลการจับคู่หม้อแปลงกับมิเตอร์ในไฟล์ที่ระบุ');
                }

                detectedMappingsDiv.innerHTML = `
                    <h5 class="text-md font-semibold text-blue-800 mb-2">ตรวจพบ ${transformerMeterMappings.length} การจับคู่:</h5>
                    <ul class="space-y-2 text-sm text-gray-700 max-h-40 overflow-y-auto p-3 bg-white rounded-lg border border-blue-200">
                        ${transformerMeterMappings.map(m => `
                            <li class="flex items-start">
                                <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                <div><strong>${m.transformerId}</strong> ➜ ${m.meterIds.length} มิเตอร์ (${m.meterIds.slice(0, 2).join(', ')}${m.meterIds.length > 2 ? ', ...' : ''})</div>
                            </li>
                        `).join('')}
                    </ul>
                `;

                showSuccess(`ตรวจพบ ${transformerMeterMappings.length} หม้อแปลง และ ${meterData.length} มิเตอร์`);
                validateInputs();

            } catch (error) {
                console.error('Error detecting mappings:', error);
                showError(`การจับคู่ล้มเหลว: ${error.message}`);
                detectedMappingsDiv.innerHTML = `<div class="text-red-600 text-sm flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>${error.message}</span></div>`;
                transformerMeterMappings = [];
                validateInputs();
            } finally {
                detectBtn.disabled = false;
                if (detectBtnText) detectBtnText.textContent = 'ตรวจสอบการจับคู่';
            }
        }

        // --- NEW REPORTING FUNCTIONS ---
        async function handleSaveReport(event) {
            event.preventDefault();
            const submitButton = elements.editReportForm.querySelector('button[type="submit"]');
            if (!submitButton) return;
            const originalButtonContent = submitButton.innerHTML;

            // Add loading state
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                <span>กำลังส่ง...</span>
            `;

            const reportData = {
                reporter_name: document.getElementById('report-name').value.trim(),
                reporter_position: document.getElementById('report-position').value.trim(),
                reporter_affiliation: document.getElementById('report-affiliation').value.trim(),
                report_details: document.getElementById('report-details').value.trim(),
                authority: elements.viewAuthoritySelect.value,
                transformer_id: elements.viewTransformerSelect.value,
                month: elements.viewMonthSelect.value,
                analysis_doc_id: `${elements.viewAuthoritySelect.value}_${elements.viewTransformerSelect.value}_${elements.viewMonthSelect.value}`
            };

            // Enhanced validation
            if (!reportData.reporter_name || !reportData.reporter_position || !reportData.reporter_affiliation || !reportData.report_details) {
                showError("กรุณากรอกข้อมูลผู้รายงานและรายละเอียดการแก้ไขให้ครบถ้วน");
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
                return;
            }
            
            if (!reportData.authority || !reportData.transformer_id || !reportData.month) {
                showError("ไม่สามารถส่งรายงานได้เนื่องจากไม่ได้เลือกข้อมูลการวิเคราะห์ (การไฟฟ้า, หม้อแปลง, เดือน)");
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
                return;
            }

            try {
                const { error } = await supabase.from('edit_reports').insert([reportData]);
                if (error) throw error;
                showSuccess("บันทึกรายงานการแก้ไขสำเร็จแล้ว");
                hideEditReportModal();
            } catch (error) {
                console.error("Error saving report:", error);
                showError(`เกิดข้อผิดพลาดในการบันทึกรายงาน: ${error.message}`);
            } finally {
                // Restore button state
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        }
        
        async function fetchAndDisplayReports() {
            const { data: reports, error } = await supabase
                .from('edit_reports')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Error fetching reports:", error);
                elements.reportsListContainer.innerHTML = `<p class="text-red-500">ไม่สามารถโหลดรายงานได้</p>`;
                return;
            }

            if (reports && reports.length > 0) {
                hideElement(elements.noReportsMessage);
                showElement(elements.reportsListContainer.querySelector('.data-table'));
                elements.reportsTableBody.innerHTML = '';
                reports.forEach(report => {
                    const row = document.createElement('tr');
                    const hasFeedback = report.admin_suggestions && report.admin_suggestions.trim() !== '';
                    row.innerHTML = `
                        <td>${new Date(report.created_at).toLocaleDateString('th-TH')}</td>
                        <td>${report.reporter_name}</td>
                        <td>${report.reporter_affiliation}</td>
                        <td>${report.transformer_id}</td>
                        <td>
                            ${hasFeedback 
                             ? '<span class="status-indicator status-success">ตอบกลับแล้ว</span>' 
                             : '<span class="status-indicator status-warning">รอตรวจสอบ</span>'
                            }
                        </td>
                        <td>
                            <button class="btn-secondary text-sm view-details-btn">ดูรายละเอียด</button>
                        </td>
                    `;
                    row.querySelector('.view-details-btn').addEventListener('click', () => showReportDetailsModal(report));
                    elements.reportsTableBody.appendChild(row);
                });
            } else {
                showElement(elements.noReportsMessage);
                hideElement(elements.reportsListContainer.querySelector('.data-table'));
            }
        }

        async function handleSaveAdminSuggestion() {
            if (!currentReportId) return;
            const suggestions = elements.adminSuggestions.value;
            try {
                const { error } = await supabase
                    .from('edit_reports')
                    .update({ admin_suggestions: suggestions })
                    .eq('id', currentReportId);
                if (error) throw error;
                showSuccess("บันทึกข้อเสนอแนะสำเร็จ");
            } catch (error) {
                console.error("Error saving suggestion:", error);
                showError("เกิดข้อผิดพลาดในการบันทึกข้อเสนอแนะ");
            }
        }

        async function handleAnalyzeReport() {
            if (!currentReportId) return;
            showElement(elements.reportAiLoader);
            elements.reportAiAnalysisContent.innerHTML = '';

            const reportDetails = elements.detailsReportDetails.textContent;
            const adminSuggestions = elements.adminSuggestions.value;

            const prompt = `ในฐานะผู้จัดการฝ่ายวิศวกรรมไฟฟ้า, โปรดวิเคราะห์รายงานการแก้ไขปัญหาระบบไฟฟ้าดังนี้:
---
**รายละเอียดการแก้ไขจากผู้ปฏิบัติงาน:**
${reportDetails}
---
**ข้อเสนอแนะจาก Admin:**
${adminSuggestions || "ไม่มี"}
---
โปรดประเมิน:
1.  **ความถูกต้องของการแก้ไข:** การดำเนินการสอดคล้องกับปัญหาที่อาจเกิดขึ้นหรือไม่?
2.  **ประสิทธิผลที่คาดหวัง:** การแก้ไขนี้น่าจะช่วยลดค่า Loss ได้มากน้อยเพียงใด?
3.  **ความเสี่ยงที่อาจเกิดขึ้น:** มีความเสี่ยงหรือผลกระทบข้างเคียงจากการแก้ไขนี้หรือไม่?
4.  **คำแนะนำเพิ่มเติม:** มีขั้นตอนอื่นที่ควรทำเพิ่มเติมเพื่อยืนยันผลหรือป้องกันปัญหาในอนาคตหรือไม่?

ใช้ภาษาไทย, สรุปให้กระชับ และจัดรูปแบบด้วย Markdown`;
            
            try {
                const analysisText = await callGeminiAPI(prompt);
                elements.reportAiAnalysisContent.innerHTML = marked.parse(analysisText);
                // Save analysis to DB
                await supabase
                    .from('edit_reports')
                    .update({ ai_report_analysis: analysisText })
                    .eq('id', currentReportId);
            } catch (error) {
                console.error("Error analyzing report:", error);
                elements.reportAiAnalysisContent.innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาดในการวิเคราะห์: ${error.message}</p>`;
            } finally {
                hideElement(elements.reportAiLoader);
            }
        }
        
        async function handleGenerateAiSuggestion() {
            const btn = elements.generateSuggestionAiBtn;
            if (!btn) return;
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="ai-spinner" style="width: 16px; height: 16px; border-width: 2px; border-top-color: var(--primary-500);"></div>`;

            const reportDetails = elements.detailsReportDetails.textContent;
            const prompt = `จากรายงานการแก้ไขของผู้ปฏิบัติงาน:
        ---
        ${reportDetails}
        ---
        ในฐานะผู้ดูแลระบบ โปรดเขียนข้อเสนอแนะสั้นๆ ที่ให้กำลังใจและเป็นประโยชน์แก่ผู้ปฏิบัติงาน ควรมีการขอบคุณสำหรับการรายงาน และอาจจะเสนอแนะขั้นตอนต่อไป (ถ้ามี) ให้ใช้ภาษาไทยที่สุภาพและเป็นทางการ`;

            try {
                const suggestionText = await callGeminiAPI(prompt);
                elements.adminSuggestions.value = suggestionText.trim();
            } catch (error) {
                console.error("Error generating AI suggestion:", error);
                showError("ไม่สามารถสร้างข้อเสนอแนะด้วย AI ได้");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
            }
        }

        async function handleDeleteReport(reportId) {
            if (!reportId) return;

            showConfirmModal({
                title: "ยืนยันการลบรายงาน",
                text: `คุณต้องการลบรายงานนี้อย่างถาวรใช่หรือไม่?`,
                onConfirm: async () => {
                    console.log(`Deleting report with id: ${reportId}`);
                    try {
                        const { error } = await supabase
                            .from('edit_reports')
                            .delete()
                            .eq('id', reportId);

                        if (error) throw error;
                        
                        showSuccess("ลบรายงานสำเร็จแล้ว");
                        hideReportDetailsModal();
                        // The onSnapshot listener will automatically update the reports list.
                    } catch (error) {
                        console.error("Error deleting report:", error);
                        showError(`เกิดข้อผิดพลาดในการลบรายงาน: ${error.message}`);
                    }
                }
            });
        }
        
        async function checkAndDisplayFeedback() {
            const docId = `${elements.viewAuthoritySelect.value}_${elements.viewTransformerSelect.value}_${elements.viewMonthSelect.value}`;
            if (!docId) {
                hideElement(elements.userViewReportFeedbackSection);
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('edit_reports')
                    .select('admin_suggestions')
                    .eq('analysis_doc_id', docId)
                    .not('admin_suggestions', 'is', null)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0 && data[0].admin_suggestions) {
                    elements.userViewFeedbackContent.innerHTML = marked.parse(data[0].admin_suggestions);
                    showElement(elements.userViewReportFeedbackSection);
                } else {
                    hideElement(elements.userViewReportFeedbackSection);
                }
            } catch (error) {
                console.error("Error checking for feedback:", error);
                hideElement(elements.userViewReportFeedbackSection);
            }
        }


        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            elements.adminLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showLoginModal();
            });

            elements.closeModalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                hideLoginModal();
            });

            elements.loginModalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.loginModalOverlay) {
                    hideLoginModal();
                }
            });
            
            elements.confirmModalCancelBtn.addEventListener('click', hideConfirmModal);
            elements.confirmModalOverlay.addEventListener('click', (e) => {
                 if (e.target === elements.confirmModalOverlay) {
                    hideConfirmModal();
                }
            });

            elements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                if (username === 'admin' && password === 'admin123') {
                    currentUser.role = 'admin';
                    hideLoginModal();
                    renderAppForRole();
                    showSuccess('เข้าสู่ระบบสำเร็จ!');
                } else {
                    const errorElement = document.getElementById('login-error');
                    errorElement.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                    showElement(errorElement);
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    document.getElementById('username').focus();
                }
            });

            elements.loginModal.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !elements.loginModalOverlay.classList.contains('hidden')) {
                    hideLoginModal();
                }
            });

            elements.logoutBtn.addEventListener('click', () => {
                currentUser.role = 'user';
                renderAppForRole();
            });

            const inputElements = [
                elements.transformerUrl, elements.meterUrl, elements.authorityInput,
                elements.startDateInput, elements.endDateInput, elements.monthInput
            ].filter(el => el !== null && el !== undefined);

            inputElements.forEach(input => {
                if (input) {
                    input.addEventListener('input', validateInputs);
                    input.addEventListener('change', validateInputs);
                    input.addEventListener('blur', validateInputs);
                }
            });

            const detectBtn = document.getElementById('detect-mappings-btn');
            const detectBtnText = document.getElementById('detect-btn-text');

            if (elements.meterUrl && detectBtn) {
                elements.meterUrl.addEventListener('input', () => {
                    const meterUrlValid = validateGoogleSheetUrl(elements.meterUrl.value.trim());
                    detectBtn.disabled = !meterUrlValid;
                    if (detectBtnText) {
                        detectBtnText.textContent = meterUrlValid ? 'ตรวจสอบการจับคู่' : 'ใส่ลิงก์มิเตอร์ก่อน';
                    }
                    updateUrlStatus('meter', meterUrlValid);
                });
            }

            if (elements.transformerUrl) {
                elements.transformerUrl.addEventListener('input', () => {
                    const transformerUrlValid = validateGoogleSheetUrl(elements.transformerUrl.value.trim());
                    updateUrlStatus('transformer', transformerUrlValid);
                });
            }

            elements.calculateBtn.addEventListener('click', (e) => {
                console.log('Calculate button event triggered');
                e.preventDefault();
                e.stopPropagation();
                calculateLoss();
            });
            
            elements.deleteBtn.addEventListener('click', deleteCurrentAnalysis);


            if (detectBtn) {
                detectBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await detectMappingsFromUrls();
                });
            }
            
            if(elements.generateActionPlanBtn) {
                elements.generateActionPlanBtn.addEventListener('click', generateActionPlan);
            }

            // New Report Listeners
            elements.showEditReportModalBtn.addEventListener('click', showEditReportModal);
            elements.closeEditReportModalBtn.addEventListener('click', hideEditReportModal);
            elements.editReportModalOverlay.addEventListener('click', (e) => {
                if(e.target === elements.editReportModalOverlay) hideEditReportModal();
            });
            elements.editReportForm.addEventListener('submit', handleSaveReport);

            elements.closeReportDetailsModalBtn.addEventListener('click', hideReportDetailsModal);
            elements.reportDetailsModalOverlay.addEventListener('click', (e) => {
                if(e.target === elements.reportDetailsModalOverlay) hideReportDetailsModal();
            });
            elements.saveAdminSuggestionBtn.addEventListener('click', handleSaveAdminSuggestion);
            elements.analyzeReportBtn.addEventListener('click', handleAnalyzeReport);
            elements.generateSuggestionAiBtn.addEventListener('click', handleGenerateAiSuggestion);
            elements.deleteReportBtn.addEventListener('click', () => handleDeleteReport(currentReportId));
        }
        
        function setupSelectorListeners(allData) {
             elements.viewAuthoritySelect.addEventListener('change', () => {
                populateTransformerSelector(allData, elements.viewAuthoritySelect.value);
                // After repopulating transformers, also repopulate months for the new (or first) transformer
                populateMonthSelector(allData, elements.viewAuthoritySelect.value, elements.viewTransformerSelect.value);
                loadSelectedData(allData);
            });
            elements.viewTransformerSelect.addEventListener('change', () => {
                populateMonthSelector(allData, elements.viewAuthoritySelect.value, elements.viewTransformerSelect.value);
                loadSelectedData(allData);
            });
            elements.viewMonthSelect.addEventListener('change', () => loadSelectedData(allData));
        }

        function setupAdminTabs() {
            elements.adminConfigTab.addEventListener('click', () => {
                elements.adminConfigTab.classList.add('active');
                elements.adminReportsTab.classList.remove('active');
                showElement(elements.adminConfigSection);
                hideElement(elements.adminReportsSection);
            });
            elements.adminReportsTab.addEventListener('click', () => {
                elements.adminReportsTab.classList.add('active');
                elements.adminConfigTab.classList.remove('active');
                showElement(elements.adminReportsSection);
                hideElement(elements.adminConfigSection);
                fetchAndDisplayReports();
            });
        }


        function updateUrlStatus(type, isValid) {
            const statusEl = document.getElementById(`${type}-url-status`);
            if (!statusEl) return;

            if (isValid) {
                statusEl.innerHTML = `✔️ ${type === 'transformer' ? 'หม้อแปลง' : 'มิเตอร์'}: พร้อมใช้งาน`;
                statusEl.className = 'px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs';
            } else {
                statusEl.innerHTML = `🔌 ${type === 'transformer' ? 'หม้อแปลง' : 'มิเตอร์'}: ยังไม่ได้ใส่`;
                statusEl.className = 'px-2 py-1 rounded-full bg-gray-100 text-gray-600 text-xs';
            }
        }

        // --- STARTUP AND INITIALIZATION ---
        async function initializeDashboard() {
            try {
                console.log('🚀 Initializing dashboard...');
                
                // Initialize Supabase client
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('YOUR_SUPABASE_URL')) {
                    throw new Error("กรุณาใส่ Supabase URL และ Anon Key ของคุณในโค้ดก่อน");
                }
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized.");

                setupEventListeners(); // Setup listeners first to make UI interactive.
                setupAdminTabs();

                const today = new Date();
                if (elements.endDateInput) {
                    elements.endDateInput.value = today.toISOString().split('T')[0];
                }
                if (elements.monthInput) {
                    elements.monthInput.value = today.toISOString().slice(0, 7);
                }

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                if (elements.startDateInput) {
                    elements.startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
                }
                
                // Fetch initial data and then subscribe to changes
                await fetchAndProcessInitialData();
                
                const analysisChannel = supabase.channel('public:analysis')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'analysis' }, payload => {
                        console.log('Analysis data change received!', payload);
                        fetchAndProcessInitialData(); // Re-fetch all data on any change
                    })
                    .subscribe();

                const reportsChannel = supabase.channel('public:edit_reports')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'edit_reports' }, payload => {
                        console.log('Edit reports change received!', payload);
                        if (!elements.adminReportsSection.classList.contains('hidden')) {
                            fetchAndDisplayReports();
                        }
                    })
                    .subscribe();
                
                console.log('✅ Dashboard initialized successfully and listening for changes.');

            } catch (error) {
                console.error('❌ Error initializing dashboard:', error);
                showError(`เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ${error.message}`);
            }
        }

        // --- ENHANCED DATA VALIDATION ---
        function validateGoogleSheetUrl(url) {
            try {
                const pattern = /^https:\/\/docs\.google\.com\/spreadsheets\/d\/[a-zA-Z0-9-_]+/;
                return pattern.test(url);
            } catch (error) {
                console.error('Error validating URL:', error);
                return false;
            }
        }

        // --- START APPLICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('🎯 DOM Content Loaded, starting application...');
                initializeDashboard();
            } catch (error) {
                console.error('❌ Critical error during application startup:', error);
                const errorDiv = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                if (errorDiv && errorText) {
                    errorText.textContent = `เกิดข้อผิดพลาดร้ายแรงในการเริ่มต้นระบบ: ${error.message}`;
                    showElement(errorDiv);
                }
            }
        });
    </script>
</body>

</html>
